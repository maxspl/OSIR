# - Base image --------------------------------
FROM ubuntu:24.04

# - Environment --------------------------------
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Europe/Minsk \
    PATH="/OSIR/OSIR:${PATH}"

# - Base system & tooling ---------------------------
RUN set -eux; \
    # timezone
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ >/etc/timezone; \
    \
    # package index & core libs
    apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        build-essential \
        zlib1g-dev \
        libncurses5-dev \
        libgdbm-dev \
        libnss3-dev \
        libssl-dev \
        libreadline-dev \
        libffi-dev \
        libsqlite3-dev \
        libbz2-dev \
        libpq-dev \
        libleveldb-dev \
        libusb-1.0-0 \
        libfuse2 \
        smbclient \
        cifs-utils \
        wget \
        jc \
        graphviz \
        git \
        software-properties-common; \
    \
    # add Deadsnakes PPA for Python 3.12
    add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update -y && \
    apt-get install -y --no-install-recommends \
        python3.12-full \
        python3.12-dev  \
        python3-pip; \
    \
    # make python3.12 the default python
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1; \
    \
    # clean apt cache to shrink image
    apt-get clean && rm -rf /var/lib/apt/lists/*

# - Python dependencies (cached layer) ---------------------
COPY sources/requirements.txt /tmp/requirements.txt
RUN set -eux; \
    python -m pip install --no-cache-dir --break-system-packages --ignore-installed -r /tmp/requirements.txt

# - Install DECODE from https://github.com/ANSSI-FR/DECODE -----------------------
RUN set -eux; \
    git clone --depth 1 https://github.com/ANSSI-FR/DECODE.git /opt/decode && \
    python -m pip install --no-cache-dir /opt/decode --break-system-packages && \
    rm -rf /opt/decode

# - Docker CLI & legacy OpenSSL (libssl1.1) ------------------
RUN set -eux; \
    wget -qO get-docker.sh https://get.docker.com && \
    sh get-docker.sh && rm get-docker.sh; \
    \
    wget -qO /tmp/libssl1.1.deb \
        http://nz2.archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb && \
    dpkg -i /tmp/libssl1.1.deb && rm /tmp/libssl1.1.deb

# - Default command ------------------------------
CMD ["/bin/bash"]
